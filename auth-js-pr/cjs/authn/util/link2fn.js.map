{"version":3,"file":"link2fn.js","names":["link2fn","sdk","tx","res","obj","link","ref","Array","isArray","name","opts","AuthSdkError","lk","find","hints","allow","length","method","get","href","withCredentials","isPolling","data","addStateToken","status","Object","assign","factorType","provider","params","autoPush","undefined","e","Promise","reject","omit","rememberDevice","profile","updatePhone","toQueryString","postToTransaction"],"sources":["../../../../lib/authn/util/link2fn.ts"],"sourcesContent":["import { OktaAuthHttpInterface } from '../../http/types';\nimport { find, omit, toQueryString } from '../../util';\nimport AuthSdkError from '../../errors/AuthSdkError';\nimport { get } from '../../http';\nimport { AuthnTransactionAPI, AuthnTransactionState } from '../types';\nimport { postToTransaction } from '../api';\nimport { addStateToken } from './stateToken';\n\n\n// query parameters to post url\ninterface PostToTransactionParams {\n  autoPush?: boolean;\n  rememberDevice?: boolean;\n  updatePhone?: boolean;\n}\n\n// eslint-disable-next-line max-params\nexport function link2fn(sdk: OktaAuthHttpInterface, tx: AuthnTransactionAPI, res, obj, link, ref) {\n  if (Array.isArray(link)) {\n    return function(name, opts?) {\n      if (!name) {\n        throw new AuthSdkError('Must provide a link name');\n      }\n\n      var lk = find(link, {name: name});\n      if (!lk) {\n        throw new AuthSdkError('No link found for that name');\n      }\n\n      return link2fn(sdk, tx, res, obj, lk, ref)(opts);\n    };\n\n  } else if (link.hints &&\n      link.hints.allow &&\n      link.hints.allow.length === 1) {\n    var method = link.hints.allow[0];\n    switch (method) {\n\n      case 'GET':\n        return function() {\n          return get(sdk, link.href, { withCredentials: true });\n        };\n\n      case 'POST':\n        // eslint-disable-next-line max-statements,complexity\n        return function(opts: AuthnTransactionState) {\n          if (ref && ref.isPolling) {\n            ref.isPolling = false;\n          }\n\n          var data = addStateToken(res, opts);\n\n          if (res.status === 'MFA_ENROLL' || res.status === 'FACTOR_ENROLL') {\n            // Add factorType and provider\n            Object.assign(data, {\n              factorType: obj.factorType,\n              provider: obj.provider\n            });\n          }\n\n          var params = {} as PostToTransactionParams;\n          var autoPush = data.autoPush;\n          if (autoPush !== undefined) {\n            if (typeof autoPush === 'function') {\n              try {\n                params.autoPush = !!autoPush();\n              }\n              catch (e) {\n                return Promise.reject(new AuthSdkError('AutoPush resulted in an error.'));\n              }\n            }\n            else if (autoPush !== null) {\n              params.autoPush = !!autoPush;\n            }\n            data = omit(data, 'autoPush');\n          }\n\n          var rememberDevice = data.rememberDevice;\n          if (rememberDevice !== undefined) {\n            if (typeof rememberDevice === 'function') {\n              try {\n                params.rememberDevice = !!rememberDevice();\n              }\n              catch (e) {\n                return Promise.reject(new AuthSdkError('RememberDevice resulted in an error.'));\n              }\n            }\n            else if (rememberDevice !== null) {\n              params.rememberDevice = !!rememberDevice;\n            }\n            data = omit(data, 'rememberDevice');\n\n          } else if (data.profile &&\n                    data.profile.updatePhone !== undefined) {\n            if (data.profile.updatePhone) {\n              params.updatePhone = true;\n            }\n            data.profile = omit(data.profile, 'updatePhone');\n          }\n          var href = link.href + toQueryString(params);\n          return postToTransaction(sdk, tx, href, data);\n        };\n    }\n  }\n}\n\n\n"],"mappings":"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"}