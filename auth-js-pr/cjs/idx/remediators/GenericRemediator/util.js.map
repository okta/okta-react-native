{"version":3,"file":"util.js","names":["unwrapFormValue","remediation","Array","isArray","map","item","res","key","value","Object","entries","formKeys","keys","includes","length","unwrappedForm","forEach","hasValidInputValue","input","values","fn","requiredTracker","name","type","options","required","isRequired","reduce","acc","selectedOption","id","optionSchema","find","option","idSchema","filter","AuthSdkError","JSON","stringify"],"sources":["../../../../../lib/idx/remediators/GenericRemediator/util.ts"],"sourcesContent":["/* eslint-disable complexity */\nimport { AuthSdkError } from '../../../errors';\nimport { Input } from '../../types';\n\nexport function unwrapFormValue(remediation): Input { \n  if (Array.isArray(remediation)) {\n    return remediation\n      .map(item => {\n        if (typeof item === 'string' || typeof item === 'number' || typeof item === 'boolean') {\n          return item;\n        }\n        return unwrapFormValue(item);\n      }) as any;\n  }\n\n  const res = {};\n  for (const [key, value] of Object.entries(remediation)) {\n    if (value === null || typeof value === 'undefined') {\n      continue;\n    }\n\n    if (typeof value === 'object') {\n      const formKeys = Object.keys(value as object);\n      // detect patterns like:\n      // value -> form -> value | form -> value\n      if (['value', 'form'].includes(key) \n        && formKeys.length === 1 \n        && ['value', 'form'].includes(formKeys[0])\n      ) {\n        // unwrap nested form\n        const unwrappedForm = unwrapFormValue(value);\n        Object.entries(unwrappedForm).forEach(([key, value]) => {\n          res[key] = value;\n        });\n      } else {\n        // dfs\n        res[key] = unwrapFormValue(value);\n      }\n    } else {\n      // handle primitive value\n      res[key] = value;\n    }\n  }\n\n  return res as Input;\n}\n\n// only check if value is required for now\n// TODO: support SDK layer type based input validation\nexport function hasValidInputValue(input, values) {\n  const fn = (input, values, requiredTracker) => {\n    const { name, value, type, options, required } = input;\n    const isRequired = required || requiredTracker;\n\n    // handle nested value - all required fields should be avaiable in values \n    if (Array.isArray(value)) {\n      return value.reduce((acc, item) => {\n        return acc && fn(item, values[name], isRequired); // recursive call\n      }, true);\n    }\n\n    // handle options field\n    // 1. object type options - check if each object field is required and value can be found from the selectedOption\n    // 2. primitive options - required field is avaiable from top level\n    // 3. unknown format - pass to backend for validation\n    if (options) {\n      // object type options\n      if (type === 'object') {\n        const selectedOption = values[name];\n        if (!selectedOption) {\n          return false;\n        }\n        if (!selectedOption.id) {\n          // unknown option format, pass to backend for validation\n          return true;\n        }\n        const optionSchema = options.find((option) => {\n          const idSchema = option.value.find(({ name }) => name === 'id' );\n          return idSchema.value === selectedOption.id;\n        });\n        if (!optionSchema) {\n          return false;\n        }\n        return optionSchema.value\n          .filter(({ required }) => !!required)\n          .reduce((acc, { name }) => {\n            return acc && !!selectedOption[name];\n          }, true);\n      }\n\n      // primitive options, not required - always valid\n      if (required === false) {\n        return true;\n      }\n\n      // primitive options, required - check if value is available\n      if (required === true) {\n        return !!values[name];\n      }\n\n      // unknown options, throw\n      throw new AuthSdkError(`Unknown options type, ${JSON.stringify(input)}`);\n    }\n\n    // base case\n    if (!isRequired) {\n      return true;\n    }\n      \n    return !!(values && values[name]);\n  };\n\n  return fn(input, values, false);\n}\n"],"mappings":"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"}