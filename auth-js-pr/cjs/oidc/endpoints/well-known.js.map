{"version":3,"file":"well-known.js","names":["getWellKnown","sdk","issuer","authServerUri","options","get","cacheResponse","getKey","kid","httpCache","storageManager","getHttpCache","cookies","then","wellKnown","jwksUri","cacheContents","getStorage","cachedResponse","Date","now","expiresAt","cachedKey","find","response","keys","clearStorage","res","key","AuthSdkError"],"sources":["../../../../lib/oidc/endpoints/well-known.ts"],"sourcesContent":["/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n *\n */\nimport { get } from '../../http';\nimport { find } from '../../util';\nimport { OktaAuthOAuthInterface, WellKnownResponse } from '../types';\nimport AuthSdkError from '../../errors/AuthSdkError';\n\nexport function getWellKnown(sdk: OktaAuthOAuthInterface, issuer?: string): Promise<WellKnownResponse> {\n  var authServerUri = (issuer || sdk.options.issuer);\n  return get(sdk, authServerUri + '/.well-known/openid-configuration', {\n    cacheResponse: true\n  });\n}\n\nexport function getKey(sdk: OktaAuthOAuthInterface, issuer: string, kid: string): Promise<string> {\n  var httpCache = sdk.storageManager.getHttpCache(sdk.options.cookies);\n\n  return getWellKnown(sdk, issuer)\n  .then(function(wellKnown) {\n    var jwksUri = wellKnown['jwks_uri'];\n\n    // Check our kid against the cached version (if it exists and isn't expired)\n    var cacheContents = httpCache.getStorage();\n    var cachedResponse = cacheContents[jwksUri];\n    if (cachedResponse && Date.now()/1000 < cachedResponse.expiresAt) {\n      var cachedKey = find(cachedResponse.response.keys, {\n        kid: kid\n      });\n\n      if (cachedKey) {\n        return cachedKey;\n      }\n    }\n\n    // Remove cache for the key\n    httpCache.clearStorage(jwksUri);\n\n    // Pull the latest keys if the key wasn't in the cache\n    return get(sdk, jwksUri, {\n      cacheResponse: true\n    })\n    .then(function(res) {\n      var key = find(res.keys, {\n        kid: kid\n      });\n\n      if (key) {\n        return key;\n      }\n\n      throw new AuthSdkError('The key id, ' + kid + ', was not found in the server\\'s keys');\n    });\n  });\n}\n"],"mappings":";;;;;AAYA;AACA;AAEA;AAfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAMO,SAASA,YAAY,CAACC,GAA2B,EAAEC,MAAe,EAA8B;EACrG,IAAIC,aAAa,GAAID,MAAM,IAAID,GAAG,CAACG,OAAO,CAACF,MAAO;EAClD,OAAO,IAAAG,SAAG,EAACJ,GAAG,EAAEE,aAAa,GAAG,mCAAmC,EAAE;IACnEG,aAAa,EAAE;EACjB,CAAC,CAAC;AACJ;AAEO,SAASC,MAAM,CAACN,GAA2B,EAAEC,MAAc,EAAEM,GAAW,EAAmB;EAChG,IAAIC,SAAS,GAAGR,GAAG,CAACS,cAAc,CAACC,YAAY,CAACV,GAAG,CAACG,OAAO,CAACQ,OAAO,CAAC;EAEpE,OAAOZ,YAAY,CAACC,GAAG,EAAEC,MAAM,CAAC,CAC/BW,IAAI,CAAC,UAASC,SAAS,EAAE;IACxB,IAAIC,OAAO,GAAGD,SAAS,CAAC,UAAU,CAAC;;IAEnC;IACA,IAAIE,aAAa,GAAGP,SAAS,CAACQ,UAAU,EAAE;IAC1C,IAAIC,cAAc,GAAGF,aAAa,CAACD,OAAO,CAAC;IAC3C,IAAIG,cAAc,IAAIC,IAAI,CAACC,GAAG,EAAE,GAAC,IAAI,GAAGF,cAAc,CAACG,SAAS,EAAE;MAChE,IAAIC,SAAS,GAAG,IAAAC,UAAI,EAACL,cAAc,CAACM,QAAQ,CAACC,IAAI,EAAE;QACjDjB,GAAG,EAAEA;MACP,CAAC,CAAC;MAEF,IAAIc,SAAS,EAAE;QACb,OAAOA,SAAS;MAClB;IACF;;IAEA;IACAb,SAAS,CAACiB,YAAY,CAACX,OAAO,CAAC;;IAE/B;IACA,OAAO,IAAAV,SAAG,EAACJ,GAAG,EAAEc,OAAO,EAAE;MACvBT,aAAa,EAAE;IACjB,CAAC,CAAC,CACDO,IAAI,CAAC,UAASc,GAAG,EAAE;MAClB,IAAIC,GAAG,GAAG,IAAAL,UAAI,EAACI,GAAG,CAACF,IAAI,EAAE;QACvBjB,GAAG,EAAEA;MACP,CAAC,CAAC;MAEF,IAAIoB,GAAG,EAAE;QACP,OAAOA,GAAG;MACZ;MAEA,MAAM,IAAIC,qBAAY,CAAC,cAAc,GAAGrB,GAAG,GAAG,uCAAuC,CAAC;IACxF,CAAC,CAAC;EACJ,CAAC,CAAC;AACJ"}